// Core Configuration
var dateCache = null;
var SCRIPT_VERSION = "2025-05-14-v8";

// Maximum allowed serial numbers per tracking number
const MAX_SERIAL_NUMBERS = 10;

function formatDate(date) {
  try {
    var month = String(date.getMonth() + 1).padStart(2, '0');
    var day = String(date.getDate()).padStart(2, '0');
    var year = date.getFullYear();
    var hours = String(date.getHours()).padStart(2, '0');
    var minutes = String(date.getMinutes()).padStart(2, '0');
    var seconds = String(date.getSeconds()).padStart(2, '0');
    return `${month}/${day}/${year} ${hours}:${minutes}:${seconds}`;
  } catch (err) {
    return "Invalid Date";
  }
}

function getLastEightDigits(str) {
  return String(str).trim().slice(-8).toLowerCase();
}

/**
 * Normalizes SKU by trimming, converting to lowercase, and stripping leading zeros
 * for numeric-only strings to ensure compatibility (e.g. "01103" matches "1103").
 */
function normalizeSku(sku) {
  if (sku === null || sku === undefined) return "";
  var s = String(sku).replace(/\s+/g, "");
  // Strip leading zeros from the start of the string (e.g., "00106-B" -> "106-B")
  s = s.replace(/^0+(?!$)/, '');
  return s.toLowerCase();
}

function checkNonFnskuScanCount(sheet, input, columnIndex, startRow, isFnsku) {
  if (isFnsku) return false;
  var data = sheet.getRange(startRow + ":" + columnIndex).getValues();
  var values = data.map(row => String(row[0]).trim()).filter(val => val !== "");
  return values.filter(val => val.toLowerCase() === input.toLowerCase()).length >= 1;
}

function initializeLogSheet() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var logSheet = spreadsheet.getSheetByName("Logs");
    if (!logSheet) {
      logSheet = spreadsheet.insertSheet("Logs");
      logSheet.getRange("A1:C1").setValues([["Timestamp", "Action", "Details"]]);
      logSheet.getRange("A1:C1").setFontWeight("bold");
      SpreadsheetApp.flush();
    }
    return logSheet;
  } catch (err) {
    throw err;
  }
}

function logError(operation, error) {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var logSheet = spreadsheet.getSheetByName("Logs");
    if (!logSheet) return;
    var timestamp = formatDate(new Date());
    logSheet.appendRow([timestamp, "ERROR: " + operation, error.toString()]);
    SpreadsheetApp.flush();
  } catch (err) { }
}

function logInfo(operation, info) {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var logSheet = spreadsheet.getSheetByName("Logs");
    if (!logSheet) return;
    var timestamp = formatDate(new Date());
    logSheet.appendRow([timestamp, "INFO: " + operation, info.toString()]);
    SpreadsheetApp.flush();
  } catch (err) { }
}

// Date Caching System
function initializeDateCache() {
  dateCache = {};
  var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  var sheetsToCache = [
    { name: "Receiving", columns: [1] },
  ];

  sheetsToCache.forEach(sheetInfo => {
    var sheet = spreadsheet.getSheetByName(sheetInfo.name);
    if (!sheet) return;
    dateCache[sheetInfo.name] = {};
    sheetInfo.columns.forEach(col => {
      dateCache[sheetInfo.name][col] = {};
      var data = sheet.getRange(2, col, sheet.getLastRow() - 1).getValues();
      for (var i = 0; i < data.length; i++) {
        var dateStr = String(data[i][0]).trim();
        if (dateStr) {
          var date = new Date(dateStr);
          if (!isNaN(date.getTime())) {
            dateCache[sheetInfo.name][col][i + 2] = formatDate(date);
          }
        }
      }
    });
  });
}

function updateDateCache(sheetName, column, row, dateStr) {
  if (!dateCache) initializeDateCache();
  if (!dateCache[sheetName]) dateCache[sheetName] = {};
  if (!dateCache[sheetName][column]) dateCache[sheetName][column] = {};

  if (dateStr) {
    var date = new Date(dateStr);
    if (!isNaN(date.getTime())) {
      dateCache[sheetName][column][row] = formatDate(date);
    }
  } else {
    delete dateCache[sheetName][column][row];
  }
}

// Orders Handling
function getTodaysSheetName() {
  var today = new Date();
  var month = today.getMonth() + 1;
  var day = today.getDate();
  var year = today.getFullYear();
  return 'Sheet ' + month + '/' + day + '/' + String(year).slice(-2); // e.g., Sheet 5/20/25
}

function handleOrdersEdit(sheet, range, row, column) {
  try {
    if (row > 1000) {
      range.setValue("");
      return;
    }
    const input = String(range.getValue()).trim();
    if (!input) return;
    // Column K tracking numbers - no automatic actions
  } catch (err) {
    logError("Orders Edit", err);
  }
}

// Receiving Handling
function handleReceivingEdit(spreadsheet, sheet, range, row) {
  try {
    if (row > 1000) {
      range.setValue("");
      return;
    }

    var input = String(range.getValue()).trim();
    if (!input) return;

    // Carrier detection for Receiving
    var carrier = detectCarrier(input);
    sheet.getRange(row, 3).setValue(carrier); // Column C

    var timestamp = formatDate(new Date());
    sheet.getRange(row, 1).setValue(timestamp);
    updateDateCache("Receiving", 1, row, timestamp);
  } catch (err) {
    console.error("Receiving Edit Error:", err);
  }
}

// FBA Related Functions
function updateAllOrdersShippingDate(spreadsheet, tracking) {
  try {
    // Remove legacy Tested Orders logic
    // Update Tech_X Orders
    updateTechOrdersShippingDateAndProductName(spreadsheet, tracking);
  } catch (err) {
    logError("Update Tech Orders Shipping Date", err);
  }
}

// handleFbaPlanFnskuInput function removed - FBA Plan logic no longer used

// handleScanFbaInFnskuInput function removed - FBA Shipping sheet no longer used

function checkForDuplicates(sheet, input, columnIndex, startRow, isFnsku) {
  if (isFnsku) return false;
  var data = sheet.getRange(startRow + ":" + columnIndex).getValues();
  var values = data.map(row => String(row[0]).trim()).filter(val => val !== "");
  return values.includes(input);
}

// Main Trigger
function onEdit(e) {
  try {
    dateCache = null;
    if (!e || !e.range) return;

    var range = e.range;
    var sheet = range.getSheet();
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var sheetName = sheet.getName();
    var row = range.getRow();
    var column = range.getColumn();

    if (sheetName === "Orders" && row >= 2 && row <= 1000 && (column === 11 || column === 7)) {
      handleOrdersEdit(sheet, range, row, column);
    }

    // Add formatting for column M edits in Orders
    if (sheetName === "Orders" && column === 13 && row >= 2 && row <= 1000) {
      // Set background color to #e06666 and text to bold for columns C to I in the edited row
      var formatRange = sheet.getRange(row, 3, 1, 7); // C (3) to I (9) is 7 columns
      formatRange.setBackground("#e06666");
      formatRange.setFontWeight("bold");
    }

    if (sheetName === "Receiving" && column === 2 && row >= 2 && row <= 1000) {
      handleReceivingEdit(spreadsheet, sheet, range, row);
      updateReceivingDailyCount(sheet);
    }

    // FBA Plan logic removed

    // --- Begin Packer_1 to Packer_10 logic ---

    if (/^Packer_([1-9]|10)$/.test(sheetName) && column === 2 && row >= 2) {
      var inputValue = String(range.getValue()).trim();
      if (inputValue === "") return;

      // --- New: Comprehensive Duplicate Check ---
      var lastRow = sheet.getLastRow();
      if (lastRow > 2) {
        var bData = sheet.getRange(1, 2, lastRow, 1).getValues();
        for (var i = 0; i < bData.length; i++) {
          var currRow = i + 1;
          if (currRow === row) continue;
          if (String(bData[i][0]).trim() === inputValue && inputValue !== "") {
            // Duplicate found. Delete the highest row number.
            var rowToDelete = Math.max(row, currRow);
            sheet.deleteRow(rowToDelete);
            updatePackerDailyCounts(sheet);
            activateNextAvailablePackerRow(sheet);
            return;
          }
        }
      }
      // --- End Duplicate Check ---

      // Priority 1: Check if input contains colon - always treat as SKU
      if (inputValue.includes(':')) {
        const skuBeforeColon = inputValue.split(':')[0].trim();
        if (skuBeforeColon) {
          // Increase stock for the base SKU in Sku-Stock and get title
          var packedSheet = spreadsheet.getSheetByName('Sku-Stock');
          if (packedSheet) {
            var packedData = packedSheet.getDataRange().getValues();
            var skuFound = false;
            for (var j = 1; j < packedData.length; j++) {
              var packedSku = String(packedData[j][1]).trim(); // B column
              if (normalizeSku(packedSku) === normalizeSku(skuBeforeColon)) {
                skuFound = true;
                var currentQty = Number(packedData[j][0]) || 0; // A column
                packedSheet.getRange(j + 1, 1).setValue(currentQty + 1);

                // Get title from D column and set it in Packer column D
                var title = String(packedData[j][3]).trim(); // D column
                if (title) {
                  sheet.getRange(row, 4).setValue(title); // D column in Packer
                }

                // Highlight B column green for successful SKU colon scan
                sheet.getRange(row, 2).setBackground("#00FF00");

                break;
              }
            }
            // If SKU with colon not found, highlight red
            if (!skuFound) {
              sheet.getRange(row, 2).setBackground("#FF0000");
            }
          }

          // Set timestamp in A and carrier as 'SKU' in C
          var timestamp = formatDate(new Date());
          sheet.getRange(row, 1).setValue(timestamp);
          updateDateCache(sheetName, 1, row, timestamp);
          sheet.getRange(row, 3).setValue('SKU');

          // Update per-day counts F-I (Order/FBA/SKU/QTY)
          updatePackerDailyCounts(sheet);
          return; // Exit early for colon format
        }
      }

      // Tracking identification for further processing
      var carrierType = detectCarrier(inputValue);

      // Packer shortcuts removed - sizes now handled by Tech sheets

      // X0 FNSKU logic removed - FBA Shipping sheet no longer used

      var isFbaScan = /^X0|^B0/i.test(inputValue);
      var isSkuWithOptionalX = /^\s*\d+(\s*[xX]\s*\d+)?\s*$/i.test(inputValue.replace(/\s+/g, ''));
      var isUsavSku = /^\s*\d+-[A-Z]\s*$/i.test(inputValue.replace(/\s+/g, ''));
      // Set timestamp in A
      var timestamp = formatDate(new Date());
      sheet.getRange(row, 1).setValue(timestamp);
      updateDateCache(sheetName, 1, row, timestamp);
      // Update per-day counts F-I (Order/FBA/SKU/QTY)
      updatePackerDailyCounts(sheet);

      // Identify carrier first before deciding which sheet to scan
      var carrier = detectCarrierOrFba(inputValue);

      // Only scan Shipped sheet if carrier is UPS, USPS, or FedEx
      var trackingFoundInShipped = false;
      var trackingFoundInOrders = false;
      if (carrier === "UPS" || carrier === "USPS" || carrier === "FedEx") {
        // Check Orders sheet first for tracking validation
        var ordersSheet = spreadsheet.getSheetByName("Orders");
        if (ordersSheet) {
          var ordersLastRow = ordersSheet.getLastRow();
          if (ordersLastRow >= 2) {
            var kDataOrders = ordersSheet.getRange("K2:K" + ordersLastRow).getValues(); // K column
            for (var k = 0; k < kDataOrders.length; k++) {
              if (getLastEightDigits(kDataOrders[k][0]) === getLastEightDigits(inputValue)) {
                trackingFoundInOrders = true;
                break;
              }
            }
          }
        }

        var shippedSheet = spreadsheet.getSheetByName("Shipped");
        if (shippedSheet) {
          var shippedLastRow = shippedSheet.getLastRow();
          if (shippedLastRow >= 2) {
            var eData = shippedSheet.getRange("E2:E" + shippedLastRow).getValues(); // E column (Shipping TRK # - match input here)

            for (var i = 0; i < eData.length; i++) {
              if (getLastEightDigits(eData[i][0]) === getLastEightDigits(inputValue)) {
                // Get additional data from Shipped sheet for copying
                var cDataShipped = shippedSheet.getRange("C2:C" + shippedLastRow).getValues(); // C column

                // Copy product title from Shipped to Packer
                var cData = cDataShipped[i][0]; // C column in Shipped (Product Title)
                sheet.getRange(row, 4).setValue(cData); // Product Title → D in Packer

                // Highlight B column cell green after paste is done
                sheet.getRange(row, 2).setBackground("#00FF00"); // B column green

                // Mark current PST time in Shipped A column
                var timestamp = formatDate(new Date());
                shippedSheet.getRange(i + 2, 1).setValue(timestamp); // A column

                // Mark G column (Box) with Packer name
                var packerName = getPackerName(sheetName);
                shippedSheet.getRange(i + 2, 7).setValue(packerName); // G column (Box)

                // Sort Shipped sheet by A column (A to Z - earliest to latest)
                var sortRange = shippedSheet.getRange(2, 1, shippedLastRow - 1, shippedSheet.getLastColumn());
                sortRange.sort(1); // Sort by column 1 (A column)

                logError("Packer Transfer", "Shipped row " + (i + 2) + " processed from " + sheetName);
                trackingFoundInShipped = true;
                break;
              }
            }
          }
        }

        // If tracking number not found in Orders or Shipped, highlight Packer B column red
        if (!trackingFoundInOrders && !trackingFoundInShipped) {
          sheet.getRange(row, 2).setBackground("#FF0000"); // Only B column red
        }
        // --- Move cursor to next available row in B for tracking check ---
        activateNextAvailablePackerRow(sheet);
      }
      // For non-UPS/USPS/FedEx carriers (SKU, FBA, etc.), the existing logic below will handle them

      // Update carrier in C (always set carrier type) - use already detected carrier
      if (carrier !== 'Unknown') {
        sheet.getRange(row, 3).setValue(carrier);
      }

      // Update per-day counts F-I (Order/FBA/SKU/QTY)
      updatePackerDailyCounts(sheet);

      // --- New: If B matches SKU pattern, set C to 'SKU' ---
      // Only check for SKU pattern if carrier is Unknown, FBA, or not a tracking number
      // This prevents overwriting tracking number carriers (UPS/USPS/FedEx) with 'SKU'
      if (carrier === 'Unknown' || carrier === 'FBA') {
        var bVal = String(sheet.getRange(row, 2).getValue()).replace(/\s+/g, '');
        var skuMatch = bVal.match(/^(\d+)(?:[xX](\d+))?$/);
        var usavSkuMatch = bVal.match(/^(\d+)-([A-Z])$/i);
        if (skuMatch || usavSkuMatch) {
          sheet.getRange(row, 3).setValue('SKU');
          // --- New: If ends with xN, add N to qty in Sku-Stock; if just SKU, add 1 ---
          var packedSheet = spreadsheet.getSheetByName('Sku-Stock');
          if (packedSheet) {
            var packedLastRow = packedSheet.getLastRow();
            var packedBData = packedSheet.getRange(2, 2, packedLastRow - 1, 1).getValues(); // B
            var skuToMatch, qtyToAdd;

            if (skuMatch) {
              skuToMatch = skuMatch[1];
              qtyToAdd = skuMatch[2] ? parseInt(skuMatch[2], 10) : 1;
            } else if (usavSkuMatch) {
              skuToMatch = usavSkuMatch[1] + '-' + usavSkuMatch[2].toUpperCase();
              qtyToAdd = 1;
            }

            var skuFound = false;
            for (var i = 0; i < packedBData.length; i++) {
              if (normalizeSku(packedBData[i][0]) === normalizeSku(skuToMatch)) {
                skuFound = true;
                var currentQty = Number(packedSheet.getRange(i + 2, 1).getValue()) || 0;
                packedSheet.getRange(i + 2, 1).setValue(currentQty + qtyToAdd);

                // Highlight green if found
                sheet.getRange(row, 2).setBackground("#00FF00");
                break;
              }
            }

            // If regular SKU pattern not found, highlight red
            if (!skuFound) {
              sheet.getRange(row, 2).setBackground("#FF0000");
            }

            // --- New: If C is 'SKU', look up B in Sku-Stock and copy D to D ---
            var packedDData = packedSheet.getRange(2, 4, packedLastRow - 1, 1).getValues(); // D
            var skuToLookup;

            if (skuMatch) {
              skuToLookup = skuMatch[1];
            } else if (usavSkuMatch) {
              skuToLookup = usavSkuMatch[1] + '-' + usavSkuMatch[2].toUpperCase();
            }

            for (var j = 0; j < packedBData.length; j++) {
              if (normalizeSku(packedBData[j][0]) === normalizeSku(skuToLookup)) {
                var packedDVal = String(packedDData[j][0]).trim();
                sheet.getRange(row, 4).setValue(packedDVal); // D column in Packer
                break;
              }
            }
          }
        }
      }

      // --- If C equals FBA, pull product name from Scan FBA In ---
      var colC = String(sheet.getRange(row, 3).getValue()).trim().toUpperCase();
      if (colC === 'FBA') {
        var scanFbaInSheet = spreadsheet.getSheetByName('Scan FBA In');
        if (scanFbaInSheet) {
          var scanLastRow = scanFbaInSheet.getLastRow();
          var scanEData = scanFbaInSheet.getRange(2, 5, scanLastRow - 1, 1).getValues(); // E
          var scanBData = scanFbaInSheet.getRange(2, 2, scanLastRow - 1, 1).getValues(); // B
          var bValue = String(sheet.getRange(row, 2).getValue()).trim();
          for (var i = 0; i < scanEData.length; i++) {
            if (String(scanEData[i][0]).trim() === bValue) {
              var productName = String(scanBData[i][0]).trim();
              sheet.getRange(row, 4).setValue(productName); // D column in Packer
              break;
            }
          }
        }
      }
    }
    // --- End Packer_1 to Packer_10 logic ---

    // Tech_X Orders Handling - F column (status field from Orders J)
    if (
      /^Tech_([1-9]|10)$/.test(sheetName) &&
      column === 6 && row >= 2 && row <= 1000
    ) {
      const input = String(range.getValue()).trim();
      // No special highlighting for F column edits - only tracking numbers should highlight yellow
    }

    // Tech_X Orders Handling (for Tech_1 to Tech_10)
    if (
      /^Tech_([1-9]|10)$/.test(sheetName) &&
      column === 5 && row >= 2 && row <= 1000
    ) {
      const input = String(range.getValue()).trim();
      if (input) {
        // Check if it's an FNSKU first
        const isFnsku = /^X0/i.test(input);

        // First, try to handle as tracking number or serial number
        handleTechOrdersEdit(spreadsheet, sheet, range, row, column);

        // Update Tech daily counts
        updateTechDailyCounts(sheet);

        // Only check checklist progression if it wasn't an FNSKU
        // (FNSKU processing and size processing already clear the input and return)
        if (!isFnsku) {
          const targetRow = parseInt(PropertiesService.getScriptProperties().getProperty('lastTrackingRow_' + sheetName));
          if (targetRow) {
            const progressionHandled = handleTechChecklistProgression(spreadsheet, sheet, input, targetRow);
            if (progressionHandled) {
              // Clear the input if it was a valid checklist keyword
              range.setValue("");
            }
          }
        }
      }
    }

    // --- New: Decrement Sku-Stock QTY from all Tech_X Orders sheets on E scan ---
    if (/^Tech_([1-9]|10)$/.test(sheetName) && column === 5 && row >= 2 && row <= 1000) {
      try {
        var packedSheet = spreadsheet.getSheetByName("Sku-Stock");
        if (packedSheet) {
          var packedData = packedSheet.getDataRange().getValues();
          var input = String(range.getValue()).replace(/\s+/g, '').toLowerCase();
          var match = input.match(/^(\d+)(?:[xX](\d+))?$/i);
          if (match) {
            var sku = match[1];
            var qty = match[2] ? parseInt(match[2], 10) : 1;
            for (var j = 1; j < packedData.length; j++) {
              var packedSku = packedData[j][1];
              if (normalizeSku(packedSku) === normalizeSku(sku)) {
                var currentQty = Number(packedData[j][0]) || 0;
                var newQty = Math.max(0, currentQty - qty);
                packedSheet.getRange(j + 1, 1).setValue(newQty);
                break;
              }
            }
          }
        }
      } catch (err) {
        logError("Tech_X Orders decrement Sku-Stock", err);
      }
    }

    // --- Begin Tech_X Orders highlight logic ---
    if (/^Tech_([1-9]|10)$/.test(sheetName) && column === 3 && row >= 2) {
      var techTracking = String(range.getValue()).trim();
      if (techTracking !== "") {
        var outOfStockSheet = spreadsheet.getSheetByName("Orders");
        if (outOfStockSheet) {
          var outLastRow = outOfStockSheet.getLastRow();
          var kData = outOfStockSheet.getRange("K2:K" + outLastRow).getValues();
          for (var i = 0; i < kData.length; i++) {
            if (getLastEightDigits(kData[i][0]) === getLastEightDigits(techTracking)) {
              outOfStockSheet.getRange(i + 2, 1, 1, outOfStockSheet.getLastColumn()).setBackground("#FFFF00");
              break;
            }
          }
        }
      }
    }
    // --- End Tech_X Orders highlight logic ---

    // ALL Shipping logic removed - sheet no longer used

    // --- Sku timestamp removed - now handled by Vercel server ---

  } catch (err) {
    logError("Main onEdit", err);
  }
}

// Setup Functions
function setupScript() {
  try {
    // Set up onEdit trigger if not exists
    const triggers = ScriptApp.getProjectTriggers();
    const hasOnEdit = triggers.some(trigger =>
      trigger.getHandlerFunction() === "onEdit" &&
      trigger.getEventType() === ScriptApp.EventType.ON_EDIT
    );

    if (!hasOnEdit) {
      ScriptApp.newTrigger("onEdit")
        .forSpreadsheet(SpreadsheetApp.getActiveSpreadsheet())
        .onEdit()
        .create();
    }

  } catch (err) {
    logError("Setup Script", err);
  }
}

function detectCarrier(tracking) {
  if (!tracking) return "Unknown";
  tracking = String(tracking).trim().toUpperCase();
  if (tracking.startsWith("1Z")) return "UPS";
  if (tracking.startsWith("94") || tracking.startsWith("92") || tracking.startsWith("93") || tracking.startsWith("42")) return "USPS";
  if (tracking.startsWith("96")) return "FedEx";
  if (tracking.startsWith("JD") || tracking.startsWith("JJD")) return "DHL";
  if (tracking.startsWith("TBA")) return "AMAZON";
  return "Unknown";
}

function detectCarrierOrFba(tracking) {
  if (!tracking) return "Unknown";
  tracking = String(tracking).trim().toUpperCase();
  if (tracking.startsWith("FBA")) return "FBA";
  if (tracking.startsWith("X0") || tracking.startsWith("B0")) return "FBA";
  if (tracking.startsWith("1Z")) return "UPS";
  if (tracking.startsWith("94") || tracking.startsWith("92") || tracking.startsWith("93") || tracking.startsWith("42")) return "USPS";
  if (tracking.startsWith("96")) return "FedEx";
  if (tracking.startsWith("JD") || tracking.startsWith("JJD")) return "DHL";
  return "Unknown";
}

function updateDailyCount(sheet, dateCol, countCol) {
  var lastRow = sheet.getLastRow();
  if (lastRow < 2) return;
  var dates = sheet.getRange(2, dateCol, lastRow - 1, 1).getValues();
  var dateMap = {};
  // Normalize and count
  for (var i = 0; i < dates.length; i++) {
    var d = dates[i][0];
    if (d instanceof Date) {
      var dKey = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
      dateMap[dKey] = (dateMap[dKey] || 0) + 1;
    }
  }
  // Set count for each row
  for (var i = 0; i < dates.length; i++) {
    var d = dates[i][0];
    if (d instanceof Date) {
      var dKey = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
      sheet.getRange(i + 2, countCol).setValue(dateMap[dKey]);
    }
  }
}

// Checklist progression function for Tech_X Orders
function handleTechChecklistProgression(spreadsheet, sheet, input, row) {
  try {
    var inputLower = input.toLowerCase();

    // Check if input is 'yes', 'used', 'new', or 'parts'
    if (inputLower !== 'yes' && inputLower !== 'used' && inputLower !== 'new' && inputLower !== 'parts') {
      return false;
    }

    // If Used, New, or Parts is inputted, update F column with that value
    if (inputLower === 'used' || inputLower === 'new' || inputLower === 'parts') {
      // Capitalize first letter for display
      var statusValue = input.charAt(0).toUpperCase() + input.slice(1).toLowerCase();
      sheet.getRange(row, 6).setValue(statusValue); // F column
    }

    // Check if A column has red background - if so, don't transfer
    var aBackground = sheet.getRange(row, 1).getBackground();
    if (aBackground === "#ff0000" || aBackground === "#FF0000") {
      // Tracking number not found in Shipped - don't transfer
      return true; // Still return true to indicate progression was handled (input should be cleared)
    }

    // Change background to green for B-F
    sheet.getRange(row, 2, 1, 5).setBackground("#00FF00"); // B-F green

    // Transfer to Shipped sheet
    var shippedSheet = spreadsheet.getSheetByName("Shipped");
    if (!shippedSheet) {
      shippedSheet = spreadsheet.insertSheet("Shipped");
      shippedSheet.getRange("A1:I1").setValues([["Time/Date", "Platform", "Product Title", "Order #", "Order #", "Tracking #", "", "", "Tech"]]);
      shippedSheet.getRange("A1:I1").setFontWeight("bold");
    }

    // Get data from current Tech row
    var techRowData = sheet.getRange(row, 1, 1, 9).getValues()[0];
    var trackingNumber = String(techRowData[2]).trim(); // C column (tracking)

    // Find next empty row in Shipped
    var shippedLastRow = shippedSheet.getLastRow();
    var nextShippedRow = shippedLastRow + 1;

    // Determine tech name based on sheet name
    var sheetName = sheet.getName();
    var techName = "";
    if (sheetName === "Tech_1") {
      techName = "Mike";
    } else if (sheetName === "Tech_2") {
      techName = "Thuc";
    } else if (sheetName === "Tech_3") {
      techName = "Sang";
    } else if (sheetName === "Tech_4") {
      techName = "Tech_4";
    } else if (sheetName === "Tech_5") {
      techName = "Tech_5";
    } else if (sheetName === "Tech_6") {
      techName = "Tech_6";
    } else if (sheetName === "Tech_7") {
      techName = "Tech_7";
    } else if (sheetName === "Tech_8") {
      techName = "Tech_8";
    } else if (sheetName === "Tech_9") {
      techName = "Tech_9";
    } else if (sheetName === "Tech_10") {
      techName = "Tech_10";
    }

    // Map columns: Tech C→E (tracking), Tech D→F (serial numbers), Tech F→D (status), H=Tech name
    var shippedData = [
      "", // A empty (Date / Time)
      "", // B empty (Order ID)
      "", // C empty (Product Title)
      techRowData[5], // D = Tech F (Sent/Status)
      trackingNumber, // E = Tech C (Shipping TRK #)
      "", // F empty (Serial Number - will be filled from Tech D if matching tracking exists)
      "", // G empty (Box)
      techName, // H = Tech name (By)
      "" // I empty (SKU)
    ];

    // Check if this tracking number already exists in Shipped
    var existingRow = -1;
    if (shippedLastRow >= 2) {
      var eData = shippedSheet.getRange(2, 5, shippedLastRow - 1, 1).getValues(); // E column (Shipping TRK #)
      for (var i = 0; i < eData.length; i++) {
        var eVal = String(eData[i][0]).trim();
        if (eVal && getLastEightDigits(eVal) === getLastEightDigits(trackingNumber)) {
          existingRow = i + 2;
          break;
        }
      }
    }

    if (existingRow !== -1) {
      // Update existing row - update D (Sent), F (Serial Number), and H (Tech name)
      shippedSheet.getRange(existingRow, 4).setValue(techRowData[5]); // D = Tech F (Sent/Status)
      shippedSheet.getRange(existingRow, 6).setValue(techRowData[3]); // F = Tech D (Serial Number)
      shippedSheet.getRange(existingRow, 8).setValue(techName); // H = Tech name (By)
    } else {
      // Create new row
      shippedSheet.getRange(nextShippedRow, 1, 1, 9).setValues([shippedData]);
    }

    return true;
  } catch (err) {
    logError("Tech Checklist Progression", err);
    return false;
  }
}

// Tech_X Orders Handling (for Tech_1 to Tech_10)
// Column structure: A=Date/Time, B=Product Name, C=Tracking/FNSKU, D=Serial Numbers, E=Input, F=Checklist Status, G=SKU, H=Qty Count
function handleTechOrdersEdit(spreadsheet, sheet, range, row, column) {
  try {
    if (row > 1000) {
      range.setValue("");
      return;
    }
    const input = String(range.getValue()).trim();
    if (!input) return;

    // Priority 1: Check if input contains colon - always treat as SKU
    if (input.includes(':')) {
      const skuBeforeColon = input.split(':')[0].trim();
      if (skuBeforeColon) {
        // Get the current row with tracking number
        const targetRow = parseInt(PropertiesService.getScriptProperties().getProperty('lastTrackingRow_' + sheet.getName()));
        if (!targetRow) {
          range.setValue("");
          return;
        }

        // 1. Decrease stock in Sku-Stock sheet by quantity (check for x before colon)
        var skuToMatch = skuBeforeColon;
        var qtyToDecrement = 1;
        var xMatch = skuBeforeColon.match(/^(.+?)x(\d+)$/i);
        if (xMatch) {
          skuToMatch = xMatch[1]; // SKU without xN
          qtyToDecrement = parseInt(xMatch[2], 10) || 1; // N from xN
        }

        var skuStockSheet = spreadsheet.getSheetByName('Sku-Stock');
        if (skuStockSheet) {
          var stockData = skuStockSheet.getDataRange().getValues();
          for (var j = 1; j < stockData.length; j++) {
            var stockSku = String(stockData[j][1]).trim(); // B column
            if (stockSku === skuToMatch) {
              var currentQty = Number(stockData[j][0]) || 0; // A column
              var newQty = Math.max(0, currentQty - qtyToDecrement);
              skuStockSheet.getRange(j + 1, 1).setValue(newQty);
              break;
            }
          }
        }

        // 2. Retrieve serial numbers from Sku sheet and put in current row
        var skuSheet = spreadsheet.getSheetByName('Sku');
        if (skuSheet) {
          var skuData = skuSheet.getDataRange().getValues();
          var serialNumbers = '';
          var skuSheetRow = -1;

          // Find matching SKU in column B and get serial numbers from column C
          for (var i = 1; i < skuData.length; i++) {
            var bucketSku = String(skuData[i][1]).trim(); // Column B
            if (bucketSku === input) { // Match the full unique SKU
              serialNumbers = String(skuData[i][2]).trim(); // Column C
              skuSheetRow = i + 1;

              // Check if there are notes in column G and show alert
              var notes = String(skuData[i][6]).trim(); // Column G
              if (notes) {
                SpreadsheetApp.getUi().alert('Notes for SKU ' + input + ':\n\n' + notes);
              }
              break;
            }
          }

          if (serialNumbers) {
            // Add serial numbers to column D in current row
            var existingSerialData = String(sheet.getRange(targetRow, 4).getValue()).trim();
            if (existingSerialData) {
              sheet.getRange(targetRow, 4).setValue(existingSerialData + ', ' + serialNumbers);
            } else {
              sheet.getRange(targetRow, 4).setValue(serialNumbers);
            }
          }

          // 4. Copy tracking number from C column to Sku sheet D column
          if (skuSheetRow > 0) {
            var trackingNumber = String(sheet.getRange(targetRow, 3).getValue()).trim(); // C column
            if (trackingNumber) {
              skuSheet.getRange(skuSheetRow, 4).setValue(trackingNumber); // D column in Sku sheet
            }
          }
        }

        // 3. Move the scanned SKU to G column in current row
        sheet.getRange(targetRow, 7).setValue(input); // G column
        range.setValue("");
        return;
      }
    }

    // Priority 2: Process tracking numbers first (before other checks)
    // Tracking number regex - updated to include longer USPS numbers
    const isTracking = input.match(/^(1Z|42|93|96|JJD|JD|94|92|JVGL|420)/i);

    if (isTracking !== null) {
      // Check if this tracking number already exists in the sheet
      const lastRow = sheet.getLastRow();
      let targetRow = -1;
      let isReset = false;

      // First, check if tracking number already exists
      for (let i = 2; i <= lastRow; i++) {
        const existingTracking = String(sheet.getRange(i, 3).getValue()).trim();
        if (existingTracking === input) {
          targetRow = i;
          isReset = true;
          break;
        }
      }

      // If not found, find first empty row for new tracking number
      if (targetRow === -1) {
        for (let i = 2; i <= lastRow + 1; i++) {
          const currentTracking = sheet.getRange(i, 3).getValue(); // C
          if (!currentTracking) {
            targetRow = i;
            break;
          }
        }
        if (targetRow === -1) {
          targetRow = lastRow + 1;
        }
      }

      // Set tracking number in C
      sheet.getRange(targetRow, 3).setValue(input);
      // Set test date/time in A
      const now = new Date();
      sheet.getRange(targetRow, 1).setValue(now);

      // Check if tracking number exists in Shipped sheet and copy data if found
      const shippedSheet = spreadsheet.getSheetByName("Shipped");
      var trackingFound = false;
      if (shippedSheet) {
        const shippedLastRow = shippedSheet.getLastRow();
        if (shippedLastRow >= 2) {
          const eData = shippedSheet.getRange("E2:E" + shippedLastRow).getValues(); // E column (Shipping TRK #)
          const cData = shippedSheet.getRange("C2:C" + shippedLastRow).getValues(); // C column (Product Title)
          const dData = shippedSheet.getRange("D2:D" + shippedLastRow).getValues(); // D column (Sent/Status)

          for (let i = 0; i < eData.length; i++) {
            if (getLastEightDigits(eData[i][0]) === getLastEightDigits(input)) {
              // Copy product title from Shipped C to Tech B
              const productName = cData[i][0];
              sheet.getRange(targetRow, 2).setValue(productName); // B

              // Copy status from Shipped D to Tech F
              var shippedStatus = String(dData[i][0]).trim();
              if (shippedStatus) {
                sheet.getRange(targetRow, 6).setValue(shippedStatus); // F column in Tech
                sheet.getRange(targetRow, 2, 1, 5).setBackground("#FFFF00"); // B-F yellow
              }

              trackingFound = true;
              break;
            }
          }
        }
      }

      // If tracking number not found in Shipped, highlight only A column red
      if (!trackingFound) {
        sheet.getRange(targetRow, 1).setBackground("#FF0000"); // Only A column red
      }

      // Store this row number in PropertiesService for serial numbers (sheet-specific)
      PropertiesService.getScriptProperties().setProperty('lastTrackingRow_' + sheet.getName(), targetRow.toString());
      // Clear the original input from column E
      range.setValue("");
      return;
    }

    // Priority 3: X0 FNSKU logic (after tracking number check)
    if (/^X0/i.test(input)) {
      var scanFbaInSheet = spreadsheet.getSheetByName("Scan FBA In");
      if (scanFbaInSheet) {
        var scanFbaInData = scanFbaInSheet.getDataRange().getValues();
        var matchRow = -1;
        for (var i = 1; i < scanFbaInData.length; i++) {
          if (String(scanFbaInData[i][4]).trim().toUpperCase() === input.toUpperCase()) {
            matchRow = i + 1;
            break;
          }
        }
        if (matchRow !== -1) {
          // Find next available row in C
          const lastRow = sheet.getLastRow();
          let targetRow = -1;
          for (let i = 2; i <= lastRow + 1; i++) {
            const currentTracking = sheet.getRange(i, 3).getValue(); // C
            if (!currentTracking) {
              targetRow = i;
              break;
            }
          }
          if (targetRow === -1) {
            targetRow = lastRow + 1;
          }
          // Set X0 in C
          sheet.getRange(targetRow, 3).setValue(input);
          // Set product title in B from Scan FBA In B
          var productName = scanFbaInSheet.getRange(matchRow, 2).getValue();
          sheet.getRange(targetRow, 2).setValue(productName);
          // Set test date/time in A
          const now = new Date();
          sheet.getRange(targetRow, 1).setValue(now);
          // Store this row number in PropertiesService for serial numbers (sheet-specific)
          PropertiesService.getScriptProperties().setProperty('lastTrackingRow_' + sheet.getName(), targetRow.toString());
          // Clear the original input from column E immediately after processing
          range.setValue("");
          return;
        } else {
          SpreadsheetApp.getUi().alert("FNSKU (X0) not found in Scan FBA In E column.");
          range.setValue("");
          return;
        }
      } else {
        SpreadsheetApp.getUi().alert("Scan FBA In sheet not found.");
        range.setValue("");
        return;
      }
    }

    // Block checklist keywords from being processed
    const checklistKeywords = ["YES", "USED", "NEW"];
    if (checklistKeywords.includes(input.toUpperCase())) {
      // This is a checklist keyword, don't process further
      return;
    }

    // --- Tech Shortcuts (Test only) ---
    var shortcutValue = input.trim();
    var shortcutUpper = shortcutValue.toUpperCase();
    if (shortcutUpper === 'TEST') {
      // Special handling for 'Test' - fill most current empty row
      // Find next available row (like tracking number logic)
      const lastRow = sheet.getLastRow();
      let targetRow = -1;

      // Look for first empty row in column C
      for (let i = 2; i <= lastRow + 1; i++) {
        const currentTracking = sheet.getRange(i, 3).getValue(); // C column
        if (!currentTracking) {
          targetRow = i;
          break;
        }
      }
      if (targetRow === -1) {
        targetRow = lastRow + 1;
      }

      // Set timestamp in A, "Testing" in C (like tracking number logic)
      const timestamp = formatDate(new Date());
      sheet.getRange(targetRow, 1).setValue(timestamp); // A column
      sheet.getRange(targetRow, 3).setValue("Testing"); // C column

      // Store this as the new target row for subsequent inputs
      PropertiesService.getScriptProperties().setProperty('lastTrackingRow_' + sheet.getName(), targetRow.toString());

      // Clear the input
      range.setValue("");
      return;
    }

    // --- Handle inputs for testing rows ---
    // Check if current target row has "Testing" in C column
    const targetRow = parseInt(PropertiesService.getScriptProperties().getProperty('lastTrackingRow_' + sheet.getName()));
    if (targetRow) {
      const cValue = String(sheet.getRange(targetRow, 3).getValue()).trim();
      if (cValue === "Testing") {
        // This is input for a testing row - put it in B column
        sheet.getRange(targetRow, 2).setValue(input); // B column
        range.setValue("");
        return;
      }
    }


    // Process as serial number (anything that's not tracking, not SKU with colon, not X0 FNSKU)
    // Reuse the targetRow variable from above
    if (!targetRow) {
      // No target row found - clear input and return
      range.setValue("");
      return;
    }

    // Verify the target row exists and has a tracking number or FNSKU in column C
    const trackingValue = String(sheet.getRange(targetRow, 3).getValue()).trim();
    if (!trackingValue) {
      // Target row doesn't have a tracking number - clear input and return
      range.setValue("");
      return;
    }

    // Get existing serial numbers in D (serial number column)
    const serialCell = sheet.getRange(targetRow, 4); // Column D
    const existingSerial = String(serialCell.getValue()).trim();

    // Add new serial number to existing ones
    if (!existingSerial) {
      serialCell.setValue(input);
    } else {
      const serialNumbers = existingSerial.split(", ");
      if (!serialNumbers.includes(input)) {
        if (serialNumbers.length >= MAX_SERIAL_NUMBERS) {
          range.setValue("");
          return;
        }
        const newValue = existingSerial + ", " + input;
        serialCell.setValue(newValue);
      }
    }

    // Check if serial number matches in Sku-Stock sheet
    var packedSheet = spreadsheet.getSheetByName("Sku-Stock");
    if (packedSheet) {
      var packedData = packedSheet.getDataRange().getValues();
      var serialFound = false;
      for (var j = 1; j < packedData.length; j++) {
        var packedSerial = String(packedData[j][2]).trim(); // Assuming serial numbers are in column C (index 2)
        if (packedSerial && packedSerial.toUpperCase() === input.toUpperCase()) {
          serialFound = true;
          break;
        }
      }
      if (serialFound) {
        // Clear the background highlighting when serial number is found
        sheet.getRange(targetRow, 2, 1, 5).setBackground(null); // B-F columns
      }
    }

    // Clear the original input from column E
    range.setValue("");
    return;
  } catch (err) {
    const ui = SpreadsheetApp.getUi();
    ui.alert("Error: " + err.toString());
    logError(sheet.getName() + " Edit", err);
  }
}

function updateReceivingDailyCount(sheet) {
  var lastRow = sheet.getLastRow();
  if (lastRow < 2) return;
  var dates = sheet.getRange(2, 1, lastRow - 1, 1).getValues(); // Column A
  var dateMap = {};
  // Normalize and count (ignore time)
  for (var i = 0; i < dates.length; i++) {
    var d = dates[i][0];
    if (d instanceof Date) {
      var dKey = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
      dateMap[dKey] = (dateMap[dKey] || 0) + 1;
    }
  }
  // Prepare output array
  var output = [];
  for (var i = 0; i < dates.length; i++) {
    var d = dates[i][0];
    var count = "";
    if (d instanceof Date) {
      var dKey = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
      count = dateMap[dKey];
    }
    output.push([count]);
  }
  // Set count for each row in D in one batch
  sheet.getRange(2, 4, output.length, 1).setValues(output);
}

// syncAllShippingFromPackers function removed - ALL Shipping sheet no longer used

function onOpen() {
  var ui = SpreadsheetApp.getUi();

  ui.createMenu('Shipping')
    .addItem('Move Orders to Shipped', 'checkTrackingInShipped')
    .addItem('Remove Duplicate Shipped', 'removeDuplicateShipped')
    .addToUi();

  ui.createMenu('Orders')
    .addItem('Delete Shipped Orders', 'transferExistingOrdersToRestock')
    .addItem('Calculate Late Orders', 'calculateLateOrders')
    .addToUi();

  ui.createMenu('SKU Tools')
    .addItem('Packed SKU Matches', 'packedSkuMatches')
    .addSeparator()
    .addItem('Update Sku-Stock from Shipped', 'updateSkuStockFromShipped')
    .addSeparator()
    .addItem('Sync Stock from Zoho', 'syncStockFromZoho')
    .addItem('Setup Hourly Stock Sync', 'setupStockSyncTrigger')
    .addItem('Remove Stock Sync Trigger', 'removeStockSyncTrigger')
    .addToUi();

  ui.createMenu('Integrity')
    .addItem('Recheck Tech Tracking', 'recheckTechTrackingIntegrity')
    .addItem('Recheck Packer Tracking', 'recheckPackerTrackingIntegrity')
    .addItem('Sync Packer Timestamps to Shipped', 'syncPackerTimestampsToShipped')
    .addSeparator()
    .addItem('Sync to Backend', 'syncToBackend')
    .addToUi();
}

// sendAvailableSkusToServer function removed - available SKUs system no longer used
// SKUs now run continuously A000-Z999 then reset to A000

/**
 * Update Sku-Stock sheet column F based on SKUs from Shipped sheet column I
 * Gathers all SKUs from Shipped sheet column I, matches them with Sku-Stock column B,
 * and sets column F to 1 for matching rows
 */
function updateSkuStockFromShipped() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var shippedSheet = spreadsheet.getSheetByName('Shipped');
    var skuStockSheet = spreadsheet.getSheetByName('Sku-Stock');
    
    if (!shippedSheet) {
      SpreadsheetApp.getUi().alert('Shipped sheet not found.');
      return;
    }
    
    if (!skuStockSheet) {
      SpreadsheetApp.getUi().alert('Sku-Stock sheet not found.');
      return;
    }
    
    // Get SKUs from Shipped sheet column I (starting from row 2)
    var shippedLastRow = shippedSheet.getLastRow();
    if (shippedLastRow < 2) {
      SpreadsheetApp.getUi().alert('No data found in Shipped sheet.');
      return;
    }
    
    var shippedIData = shippedSheet.getRange(2, 9, shippedLastRow - 1, 1).getValues(); // I column (index 9)
    var shippedSkus = [];
    
    // Collect all non-empty SKUs from Shipped column I
    for (var i = 0; i < shippedIData.length; i++) {
      var sku = String(shippedIData[i][0]).trim();
      if (sku && sku !== '') {
        shippedSkus.push(sku);
      }
    }
    
    if (shippedSkus.length === 0) {
      SpreadsheetApp.getUi().alert('No SKUs found in Shipped sheet column I.');
      return;
    }
    
    // Get SKUs from Sku-Stock sheet column B
    var skuStockLastRow = skuStockSheet.getLastRow();
    if (skuStockLastRow < 2) {
      SpreadsheetApp.getUi().alert('No data found in Sku-Stock sheet.');
      return;
    }
    
    var skuStockBData = skuStockSheet.getRange(2, 2, skuStockLastRow - 1, 1).getValues(); // B column
    var skuStockFData = skuStockSheet.getRange(2, 6, skuStockLastRow - 1, 1).getValues(); // F column
    
    // Create a map of normalized Shipped SKUs for quick lookup
    var shippedSkuMap = {};
    for (var j = 0; j < shippedSkus.length; j++) {
      var normalizedShippedSku = normalizeSku(shippedSkus[j]);
      if (normalizedShippedSku) {
        shippedSkuMap[normalizedShippedSku] = true;
      }
    }
    
    // Match and update column F
    var updatedCount = 0;
    var fValuesToUpdate = [];
    
    for (var k = 0; k < skuStockBData.length; k++) {
      var skuStockSku = String(skuStockBData[k][0]).trim();
      var normalizedSkuStockSku = normalizeSku(skuStockSku);
      
      // Check if this SKU matches any SKU from Shipped sheet
      if (normalizedSkuStockSku && shippedSkuMap[normalizedSkuStockSku]) {
        fValuesToUpdate.push([1]);
        updatedCount++;
      } else {
        // Keep existing value or set to empty
        var currentFValue = skuStockFData[k][0];
        fValuesToUpdate.push([currentFValue || '']);
      }
    }
    
    // Batch update column F
    if (fValuesToUpdate.length > 0) {
      skuStockSheet.getRange(2, 6, fValuesToUpdate.length, 1).setValues(fValuesToUpdate);
    }
    
    SpreadsheetApp.getUi().alert('Update Sku-Stock from Shipped completed!\n\n' + 
      'Processed ' + shippedSkus.length + ' SKUs from Shipped sheet.\n' +
      'Matched and updated ' + updatedCount + ' rows in Sku-Stock column F.');
    logInfo('Update Sku-Stock from Shipped', 'Updated ' + updatedCount + ' rows in Sku-Stock column F');
    
  } catch (err) {
    logError('Update Sku-Stock from Shipped', err);
    SpreadsheetApp.getUi().alert('Error updating Sku-Stock: ' + err.toString());
  }
}

// === Packer daily counts - Total only in E column ===
function updatePackerDailyCounts(sheet) {
  try {
    var lastRow = sheet.getLastRow();
    if (lastRow < 2) return;

    var aVals = sheet.getRange(2, 1, lastRow - 1, 1).getValues(); // A Date/Time
    var bVals = sheet.getRange(2, 2, lastRow - 1, 1).getValues(); // B Tracking #
    var today = new Date();
    var todayKey = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();

    // Build today's unique count only
    var todayCount = 0;
    var seenTracking = new Set();
    for (var i = 0; i < aVals.length; i++) {
      var d = aVals[i][0];
      if (!(d instanceof Date)) continue;
      var dKey = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
      if (dKey === todayKey) {
        var tracking = String(bVals[i][0]).trim();
        if (tracking && !seenTracking.has(tracking)) {
          todayCount++;
          seenTracking.add(tracking);
        }
      }
    }

    // Update only today's rows with total count in E column
    // We read existing values to preserve non-today rows
    var eVals = sheet.getRange(2, 5, lastRow - 1, 1).getValues();
    var output = [];
    var hasChanges = false;

    for (var i = 0; i < aVals.length; i++) {
      var d = aVals[i][0];
      var currentVal = eVals[i][0];
      var newVal = currentVal;

      if (d instanceof Date) {
        var dKey = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
        if (dKey === todayKey) {
          newVal = todayCount;
        }
      }

      output.push([newVal]);
      if (newVal !== currentVal) hasChanges = true;
    }

    if (hasChanges) {
      sheet.getRange(2, 5, output.length, 1).setValues(output);
    }
  } catch (err) {
    logError('updatePackerDailyCounts', err);
  }
}

/**
 * Helper to move the cursor to the first available (empty) row in Column B.
 */
function activateNextAvailablePackerRow(sheet) {
  try {
    var lastRow = sheet.getLastRow();
    if (lastRow < 1) {
      sheet.getRange(2, 2).activate();
      return;
    }
    // Check for gaps in B
    var bValues = sheet.getRange(1, 2, lastRow + 1, 1).getValues();
    for (var i = 1; i < bValues.length; i++) { // Skip header
      if (String(bValues[i][0]).trim() === "") {
        sheet.getRange(i + 1, 2).activate();
        return;
      }
    }
    // No gaps, go to lastRow + 1
    sheet.getRange(lastRow + 1, 2).activate();
  } catch (err) {
    console.error("activateNextAvailablePackerRow error:", err);
  }
}

// === Tech daily counts - Total only in H column (count per day) ===
function updateTechDailyCounts(sheet) {
  try {
    var lastRow = sheet.getLastRow();
    if (lastRow < 2) return;

    var aVals = sheet.getRange(2, 1, lastRow - 1, 1).getValues(); // A Date/Time

    // Build date-wise count map
    var dateMap = {};
    for (var i = 0; i < aVals.length; i++) {
      var d = aVals[i][0];
      if (!(d instanceof Date)) continue;
      var dKey = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
      dateMap[dKey] = (dateMap[dKey] || 0) + 1;
    }

    // Prepare output array for H column
    var output = [];
    for (var i = 0; i < aVals.length; i++) {
      var d = aVals[i][0];
      var count = 0;
      if (d instanceof Date) {
        var dKey = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
        count = dateMap[dKey] || 0;
      }
      output.push([count]);
    }

    // Update H column in one batch
    sheet.getRange(2, 8, output.length, 1).setValues(output);
  } catch (err) {
    logError('updateTechDailyCounts', err);
  }
}

// fbaFnskuProductCheck and clearFnskuCheck functions removed - FBA Shipping sheet no longer used

// New function: Packed SKU Matches
function packedSkuMatches() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = spreadsheet.getSheetByName('Orders');
    var packedSheet = spreadsheet.getSheetByName('Sku-Stock');
    if (!sheet || !packedSheet) return;
    var lastRow = sheet.getLastRow();
    if (lastRow < 2) return;

    var hData = sheet.getRange(2, 8, lastRow - 1, 1).getValues(); // H column (Orders)
    var packedData = packedSheet.getDataRange().getValues();

    // Create a map for faster lookup: Sku -> Qty
    var packedMap = new Map();
    for (var j = 1; j < packedData.length; j++) {
      var packedSkuRaw = String(packedData[j][1]).trim();
      var packedSkuNorm = normalizeSku(packedSkuRaw);
      var packedQty = Number(packedData[j][0]) || 0;
      if (packedSkuNorm) {
        packedMap.set(packedSkuNorm, packedQty);
      }
    }

    // Get current backgrounds to update only matches (C to I)
    var range = sheet.getRange(2, 3, lastRow - 1, 7); // C to I
    var backgrounds = range.getBackgrounds();
    var hasChanges = false;

    // Array to store updated H column values with zero padding
    var hValuesToUpdate = [];

    for (var i = 0; i < hData.length; i++) {
      var originalSku = String(hData[i][0]).trim();

      // Add zero padding to SKU if it's a numeric string (e.g., "5" -> "00005")
      var paddedSku = originalSku;
      if (originalSku && /^\d+$/.test(originalSku)) {
        // It's a pure numeric string, pad with zeros to 5 digits (formatting preference)
        paddedSku = String(parseInt(originalSku, 10)).padStart(5, '0');
        hValuesToUpdate.push([paddedSku]);
      } else {
        hValuesToUpdate.push([originalSku]);
      }

      // Use normalized SKU for matching (strips leading zeros from both sides)
      var skuForMatch = normalizeSku(paddedSku);

      if (skuForMatch && packedMap.has(skuForMatch) && packedMap.get(skuForMatch) >= 1) {
        // Set row to green (C to I columns)
        for (var k = 0; k < 7; k++) {
          backgrounds[i][k] = "#00FF00";
        }
        hasChanges = true;
      }
    }

    // Update H column with zero-padded values
    if (hValuesToUpdate.length > 0) {
      sheet.getRange(2, 8, hValuesToUpdate.length, 1).setValues(hValuesToUpdate);
    }

    if (hasChanges) {
      range.setBackgrounds(backgrounds);
    }

    SpreadsheetApp.getUi().alert('Packed SKU Matches: Highlighted matching rows in green. Zero-padded SKUs in H column.');
  } catch (err) {
    logError('Packed SKU Matches', err);
    SpreadsheetApp.getUi().alert('Error running Packed SKU Matches: ' + err);
  }
}

// Function to transfer Orders rows with Q=1 and non-empty K to Shipped sheet
function checkTrackingInShipped() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var ordersSheet = spreadsheet.getSheetByName("Orders");
    var shippedSheet = spreadsheet.getSheetByName("Shipped");

    if (!ordersSheet) {
      SpreadsheetApp.getUi().alert("Orders sheet not found.");
      return;
    }

    var ordersLastRow = ordersSheet.getLastRow();
    if (ordersLastRow < 2) {
      SpreadsheetApp.getUi().alert("No data found in Orders sheet.");
      return;
    }

    // Create Shipped sheet if it doesn't exist
    if (!shippedSheet) {
      shippedSheet = spreadsheet.insertSheet("Shipped");
      shippedSheet.getRange("A1:I1").setValues([["Date / Time", "Order ID", "Product Title", "Sent", "Shipping TRK #", "Serial Number", "Box", "By", "SKU"]]);
      shippedSheet.getRange("A1:I1").setFontWeight("bold");
    }

    // Get Orders data (A to K)
    var ordersData = ordersSheet.getRange(2, 1, ordersLastRow - 1, 11).getValues();

    // Get K column backgrounds to check for white/clear backgrounds
    var kBackgrounds = ordersSheet.getRange(2, 11, ordersLastRow - 1, 1).getBackgrounds();

    // Get Shipped E column (Shipping TRK #) for existence check
    var shippedLastRow = shippedSheet.getLastRow();
    var shippedTrackingSet = new Set();
    if (shippedLastRow >= 2) {
      var shippedEData = shippedSheet.getRange(2, 5, shippedLastRow - 1, 1).getValues(); // E column (Shipping TRK #)
      for (var i = 0; i < shippedEData.length; i++) {
        var t = String(shippedEData[i][0]).trim();
        if (t) shippedTrackingSet.add(getLastEightDigits(t));
      }
    }

    var rowsToAdd = [];
    var kRowsToGreen = []; // Track which K rows to mark green

    // Helper function to check if background is white/clear
    function isWhiteOrClearBackground(bg) {
      if (bg === null || bg === undefined) return true;
      if (typeof bg === 'string') {
        var bgLower = bg.toLowerCase();
        return bgLower === '#ffffff' || bgLower === '#fff' || bgLower === 'white' || bgLower === '';
      }
      return false;
    }

    for (var i = 0; i < ordersData.length; i++) {
      var row = ordersData[i];
      var kValue = String(row[10]).trim(); // K is index 10
      var kBackground = kBackgrounds[i][0]; // Background color of K cell

      // Check if K has non-empty value and white/clear background
      if (kValue !== "" && isWhiteOrClearBackground(kBackground)) {
        if (!shippedTrackingSet.has(getLastEightDigits(kValue))) {
          // Tracking number not in Shipped - prepare row for transfer
          // Shipped sheet only handles A through I (9 columns)
          var newRow = new Array(9).fill("");
          newRow[0] = ""; // A = Date / Time (empty initially)
          newRow[1] = row[2]; // B = Orders C (Order ID)
          newRow[2] = row[4]; // C = Orders E (Product Title)
          newRow[3] = row[9]; // D = Orders J (Sent)
          newRow[4] = row[10]; // E = Orders K (Shipping TRK #)
          // F, G, H, I remain empty (Serial Number, Box, By, SKU)

          rowsToAdd.push(newRow);
          shippedTrackingSet.add(getLastEightDigits(kValue));
        }

        // Always mark K column green for white/clear backgrounds (whether transferred or already exists)
        kRowsToGreen.push(i + 2); // Store actual row number for K column
      }
    }

    // Mark K column green for all white/clear background rows (whether transferred or already existed)
    var rangesToGreen = [];
    for (var j = 0; j < kRowsToGreen.length; j++) {
      rangesToGreen.push("K" + kRowsToGreen[j]);
    }
    if (rangesToGreen.length > 0) {
      ordersSheet.getRangeList(rangesToGreen).setBackground("#00FF00");
    }

    if (rowsToAdd.length > 0) {
      var startRow = shippedLastRow < 1 ? 2 : shippedLastRow + 1;
      shippedSheet.getRange(startRow, 1, rowsToAdd.length, 9).setValues(rowsToAdd);

      SpreadsheetApp.getUi().alert("Transfer completed.\n" + rowsToAdd.length + " new rows transferred to Shipped.\n" + kRowsToGreen.length + " K column cells marked green (includes existing + transferred).");
    } else if (kRowsToGreen.length > 0) {
      SpreadsheetApp.getUi().alert("No new transfers needed.\n" + kRowsToGreen.length + " K column cells marked green (tracking numbers already exist in Shipped).");
    } else {
      SpreadsheetApp.getUi().alert("No rows to process.");
    }

  } catch (err) {
    logError('Check Tracking in Shipped', err);
    SpreadsheetApp.getUi().alert('Error running transfer: ' + err);
  }
}

// Function to delete Orders rows where Shipped has non-empty A column (timestamp) matching tracking numbers
function transferExistingOrdersToRestock() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var ordersSheet = spreadsheet.getSheetByName("Orders");
    var shippedSheet = spreadsheet.getSheetByName("Shipped");

    if (!ordersSheet || !shippedSheet) {
      SpreadsheetApp.getUi().alert("Orders or Shipped sheet not found.");
      return;
    }

    var shippedLastRow = shippedSheet.getLastRow();
    var ordersLastRow = ordersSheet.getLastRow();

    if (shippedLastRow < 2 || ordersLastRow < 2) {
      SpreadsheetApp.getUi().alert("No data found in Shipped or Orders sheet.");
      return;
    }

    // Get Shipped data: A (timestamp), B (Order ID), and E (Shipping TRK #)
    var shippedData = shippedSheet.getRange(2, 1, shippedLastRow - 1, 5).getValues();

    // Build Set of tracking numbers from Shipped that have timestamp
    var shippedTrackings = new Set();
    // Build Set of order numbers from Shipped that have timestamp
    var shippedOrderNumbers = new Set();
    
    for (var i = 0; i < shippedData.length; i++) {
      var aVal = String(shippedData[i][0]).trim();
      var bVal = String(shippedData[i][1]).trim(); // B column (index 1) - Order ID
      var eVal = String(shippedData[i][4]).trim(); // E column (index 4) - Shipping TRK #
      
      // If timestamp exists, add both tracking and order number to sets
      if (aVal) {
        if (eVal) {
          shippedTrackings.add(getLastEightDigits(eVal));
        }
        if (bVal) {
          shippedOrderNumbers.add(bVal);
        }
      }
    }

    if (shippedTrackings.size === 0 && shippedOrderNumbers.size === 0) {
      SpreadsheetApp.getUi().alert("No shipped orders with timestamps found.");
      return;
    }

    // Get Orders data: C (Order ID) and K (Shipping TRK #)
    var ordersCData = ordersSheet.getRange(2, 3, ordersLastRow - 1, 1).getValues(); // C column (Order ID)
    var ordersKData = ordersSheet.getRange(2, 11, ordersLastRow - 1, 1).getValues(); // K column (Shipping TRK #)
    var rowsToDelete = new Set(); // Use Set to avoid duplicates

    // First: Match tracking numbers (Orders K column vs Shipped E column)
    for (var i = 0; i < ordersKData.length; i++) {
      var kVal = String(ordersKData[i][0]).trim();
      if (kVal && shippedTrackings.has(getLastEightDigits(kVal))) {
        rowsToDelete.add(i + 2); // Add row number (i + 2 because data starts at row 2)
      }
    }

    // Second: Match order numbers (Orders C column vs Shipped B column)
    for (var i = 0; i < ordersCData.length; i++) {
      var cVal = String(ordersCData[i][0]).trim();
      if (cVal && shippedOrderNumbers.has(cVal)) {
        rowsToDelete.add(i + 2); // Add row number (i + 2 because data starts at row 2)
      }
    }

    // Convert Set to Array and sort descending to delete safely
    var rowsToDeleteArray = Array.from(rowsToDelete);
    rowsToDeleteArray.sort(function (a, b) { return b - a; });

    if (rowsToDeleteArray.length === 0) {
      SpreadsheetApp.getUi().alert("No matching Orders rows found to delete.");
      return;
    }

    var deletedCount = 0;
    var trackingMatches = 0;
    var orderMatches = 0;
    
    // Count matches before deleting
    for (var i = 0; i < ordersKData.length; i++) {
      var kVal = String(ordersKData[i][0]).trim();
      if (kVal && shippedTrackings.has(getLastEightDigits(kVal))) {
        trackingMatches++;
      }
    }
    
    for (var i = 0; i < ordersCData.length; i++) {
      var cVal = String(ordersCData[i][0]).trim();
      if (cVal && shippedOrderNumbers.has(cVal)) {
        orderMatches++;
      }
    }

    // Delete rows
    for (var k = 0; k < rowsToDeleteArray.length; k++) {
      try {
        ordersSheet.deleteRow(rowsToDeleteArray[k]);
        deletedCount++;
      } catch (deleteErr) {
        logError("Delete Orders Row", "Failed to delete row " + rowsToDeleteArray[k] + ": " + deleteErr.toString());
      }
    }

    var message = "Deleted " + deletedCount + " rows from Orders sheet.\n\n" +
      "Tracking number matches: " + trackingMatches + "\n" +
      "Order number matches: " + orderMatches;
    SpreadsheetApp.getUi().alert(message);

  } catch (err) {
    logError("Transfer Existing Orders", err);
    SpreadsheetApp.getUi().alert("Error processing shipped orders: " + err.toString());
  }
}


// Function to remove duplicate shipped orders based on tracking numbers in column F
function removeDuplicateShipped() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var shippedSheet = spreadsheet.getSheetByName("Shipped");

    if (!shippedSheet) {
      SpreadsheetApp.getUi().alert("Shipped sheet not found.");
      return;
    }

    var lastRow = shippedSheet.getLastRow();
    if (lastRow < 2) {
      SpreadsheetApp.getUi().alert("No data in Shipped sheet.");
      return;
    }

    // Get all tracking numbers from column E (Shipping TRK #)
    var eData = shippedSheet.getRange(2, 5, lastRow - 1, 1).getValues(); // E column (5)
    var trackingMap = {}; // Map to store tracking number -> array of row numbers
    var rowsToDelete = []; // Array to store rows to delete

    // Build map of tracking numbers and their row numbers
    for (var i = 0; i < eData.length; i++) {
      var tracking = String(eData[i][0]).trim();
      if (tracking && tracking !== "") {
        var actualRow = i + 2; // Actual row number in sheet
        if (!trackingMap[tracking]) {
          trackingMap[tracking] = [];
        }
        trackingMap[tracking].push(actualRow);
      }
    }

    // Find duplicates and mark rows to delete (keep smallest row number)
    for (var tracking in trackingMap) {
      var rowNumbers = trackingMap[tracking];
      if (rowNumbers.length > 1) {
        // Sort row numbers to find the smallest (keep this one)
        rowNumbers.sort(function (a, b) { return a - b; });

        // Mark all rows except the first (smallest) for deletion
        for (var j = 1; j < rowNumbers.length; j++) {
          rowsToDelete.push(rowNumbers[j]);
        }
      }
    }

    if (rowsToDelete.length === 0) {
      SpreadsheetApp.getUi().alert("No duplicate shipped orders found.");
      return;
    }

    // Sort rows to delete in descending order to avoid row shifting issues
    rowsToDelete.sort(function (a, b) { return b - a; });

    // Delete rows from bottom to top
    var deletedCount = 0;
    for (var k = 0; k < rowsToDelete.length; k++) {
      try {
        shippedSheet.deleteRow(rowsToDelete[k]);
        deletedCount++;
      } catch (deleteErr) {
        logError("Delete Duplicate Shipped Row", "Failed to delete row " + rowsToDelete[k] + ": " + deleteErr.toString());
      }
    }

    SpreadsheetApp.getUi().alert("Shipped duplicate removal completed:\n" + deletedCount + " duplicate rows removed\n" + (rowsToDelete.length - deletedCount) + " rows failed to delete");

  } catch (err) {
    logError("Remove Duplicate Shipped", err);
    SpreadsheetApp.getUi().alert("Error removing duplicate shipped orders: " + err.toString());
  }
}

// Function to sync Packer timestamps to Shipped sheet
// Checks empty A column in Shipped and non-empty B column rows in Shipped
// Gets tracking numbers from Shipped E column (Shipping TRK #)
// Compares against Packer sheets B column
// If they match and no timestamps in the A column, copy timestamps from Packer A column to Shipped A column
// Transfer the pack name to the G column (Box) in the Shipped sheet
function syncPackerTimestampsToShipped() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var shippedSheet = spreadsheet.getSheetByName("Shipped");

    if (!shippedSheet) {
      SpreadsheetApp.getUi().alert("Shipped sheet not found.");
      return;
    }

    var shippedLastRow = shippedSheet.getLastRow();
    if (shippedLastRow < 2) {
      SpreadsheetApp.getUi().alert("No data found in Shipped sheet.");
      return;
    }

    // Get Shipped data: A column (timestamps), B column (Order ID), E column (Shipping TRK #)
    var shippedAData = shippedSheet.getRange(2, 1, shippedLastRow - 1, 1).getValues(); // A column
    var shippedBData = shippedSheet.getRange(2, 2, shippedLastRow - 1, 1).getValues(); // B column
    var shippedEData = shippedSheet.getRange(2, 5, shippedLastRow - 1, 1).getValues(); // E column (Shipping TRK #)

    var updatedCount = 0;
    var processedCount = 0;

    // Process all Packer_X sheets (Packer_1 to Packer_10)
    for (var p = 1; p <= 10; p++) {
      var packerSheetName = "Packer_" + p;
      var packerSheet = spreadsheet.getSheetByName(packerSheetName);

      if (!packerSheet) continue;

      var packerLastRow = packerSheet.getLastRow();
      if (packerLastRow < 2) continue;

      // Get Packer data: A column (timestamps), B column (tracking)
      var packerAData = packerSheet.getRange(2, 1, packerLastRow - 1, 1).getValues(); // A column
      var packerBData = packerSheet.getRange(2, 2, packerLastRow - 1, 1).getValues(); // B column

      // Process each row in Shipped sheet
      for (var s = 0; s < shippedAData.length; s++) {
        var shippedAVal = String(shippedAData[s][0]).trim();
        var shippedBVal = String(shippedBData[s][0]).trim();
        var shippedEVal = String(shippedEData[s][0]).trim();

        // Check if A column is empty and B column is non-empty
        if (!shippedAVal && shippedBVal && shippedEVal) {
          processedCount++;

          // Search for matching tracking number in Packer B column
          for (var i = 0; i < packerBData.length; i++) {
            var packerBVal = String(packerBData[i][0]).trim();

            // Compare tracking numbers using last 8 digits
            if (packerBVal && getLastEightDigits(packerBVal) === getLastEightDigits(shippedEVal)) {
              // Found match - check if Packer A column has timestamp
              var packerAVal = packerAData[i][0];

              if (packerAVal) {
                // Copy timestamp from Packer A to Shipped A
                shippedSheet.getRange(s + 2, 1).setValue(packerAVal);

                // Copy packer name to Shipped G column (Box)
                var packerName = getPackerName(packerSheetName);
                shippedSheet.getRange(s + 2, 7).setValue(packerName);

                updatedCount++;
                break; // Found match, move to next Shipped row
              }
            }
          }
        }
      }
    }

    SpreadsheetApp.getUi().alert(
      "Sync Packer Timestamps to Shipped completed.\n" +
      processedCount + " Shipped rows processed (empty A, non-empty B).\n" +
      updatedCount + " timestamps copied from Packer sheets."
    );

  } catch (err) {
    logError("Sync Packer Timestamps to Shipped", err);
    SpreadsheetApp.getUi().alert("Error running sync: " + err.toString());
  }
}

// Function to calculate late orders based on G column date vs today's date
function calculateLateOrders() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var ordersSheet = spreadsheet.getSheetByName("Orders");

    if (!ordersSheet) {
      SpreadsheetApp.getUi().alert("Orders sheet not found.");
      return;
    }

    var lastRow = ordersSheet.getLastRow();
    if (lastRow < 2) {
      SpreadsheetApp.getUi().alert("No data in Orders sheet.");
      return;
    }

    // Sort by G column (7) ascending
    ordersSheet.getRange(2, 1, lastRow - 1, ordersSheet.getLastColumn()).sort({ column: 7, ascending: true });

    // Get all dates from G column (column 7)
    var gData = ordersSheet.getRange(2, 7, lastRow - 1, 1).getValues(); // G column
    var today = new Date();
    today.setHours(0, 0, 0, 0); // Set to midnight for accurate day comparison

    var calculatedCount = 0;

    // Prepare batch arrays
    var lValues = [];
    var lBackgrounds = [];
    var lAlignments = [];
    var lFontWeights = [];

    // Calculate difference for each row
    for (var i = 0; i < gData.length; i++) {
      var gValue = gData[i][0];
      var val = "";
      var bg = null; // Clears background
      var align = "left"; // Default alignment
      var weight = "normal"; // Default weight

      if (gValue) {
        // Try to parse the date
        var orderDate = new Date(gValue);

        // Check if it's a valid date
        if (!isNaN(orderDate.getTime())) {
          orderDate.setHours(0, 0, 0, 0); // Set to midnight for accurate day comparison

          // Calculate difference in days
          var timeDiff = today.getTime() - orderDate.getTime();
          var daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

          if (daysDiff === 0) {
            // Matching today's date: green background with "*"
            val = "*";
            bg = "#00FF00";
            align = "center";
            weight = "bold";
            calculatedCount++;
          } else if (daysDiff === 1) {
            // 1 day late: yellow background
            val = 1;
            bg = "#FFFF00";
            align = "center";
            weight = "bold";
            calculatedCount++;
          } else if (daysDiff >= 2) {
            // 2 or more days late: red background
            val = daysDiff;
            bg = "#FF0000";
            align = "center";
            weight = "bold";
            calculatedCount++;
          }
        }
      }
      lValues.push([val]);
      lBackgrounds.push([bg]);
      lAlignments.push([align]);
      lFontWeights.push([weight]);
    }

    // Batch update column L
    var range = ordersSheet.getRange(2, 12, lastRow - 1, 1);
    range.setValues(lValues);
    range.setBackgrounds(lBackgrounds);
    range.setHorizontalAlignments(lAlignments);
    range.setFontWeights(lFontWeights);

    SpreadsheetApp.getUi().alert("Calculate Late Orders completed.\n" + calculatedCount + " late orders calculated and updated in column L.");

  } catch (err) {
    logError("Calculate Late Orders", err);
    SpreadsheetApp.getUi().alert("Error calculating late orders: " + err.toString());
  }
}

// Function to determine packer name based on sheet name
function getPackerName(sheetName) {
  if (sheetName === "Packer_1") {
    return "Tuan";
  } else if (sheetName === "Packer_2") {
    return "Thuy";
  } else if (sheetName === "Packer_3") {
    return "Packer_3";
  } else if (sheetName === "Packer_4") {
    return "Packer_4";
  } else if (sheetName === "Packer_5") {
    return "Packer_5";
  } else if (sheetName === "Packer_6") {
    return "Packer_6";
  } else if (sheetName === "Packer_7") {
    return "Packer_7";
  } else if (sheetName === "Packer_8") {
    return "Packer_8";
  } else if (sheetName === "Packer_9") {
    return "Packer_9";
  } else if (sheetName === "Packer_10") {
    return "Packer_10";
  }
  return sheetName; // Default to sheet name if no mapping
}

// Function to recheck Tech sheet tracking numbers in red highlighted rows
function recheckTechTrackingIntegrity() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var shippedSheet = spreadsheet.getSheetByName("Shipped");

    if (!shippedSheet) {
      SpreadsheetApp.getUi().alert("Shipped sheet not found.");
      return;
    }

    var shippedLastRow = shippedSheet.getLastRow();
    var eDataShipped = [];
    var cDataShipped = [];
    if (shippedLastRow >= 2) {
      eDataShipped = shippedSheet.getRange("E2:E" + shippedLastRow).getValues(); // E column (Shipping TRK #)
      cDataShipped = shippedSheet.getRange("C2:C" + shippedLastRow).getValues(); // C column (Product Title)
    }

    var processedCount = 0;
    var fixedCount = 0;
    var stillRedCount = 0;

    // Process all Tech_X sheets (Tech_1 to Tech_10)
    for (var t = 1; t <= 10 ; t++) {
      var techSheetName = "Tech_" + t;
      var techSheet = spreadsheet.getSheetByName(techSheetName);

      if (!techSheet) continue;

      var techLastRow = techSheet.getLastRow();
      if (techLastRow < 2) continue;

      // Get all data and backgrounds for the sheet
      var techRange = techSheet.getRange(2, 1, techLastRow - 1, techSheet.getLastColumn());
      var techData = techRange.getValues();
      var techBackgrounds = techRange.getBackgrounds();

      var rowsToUpdate = [];
      var backgroundsToUpdate = [];

      for (var i = 0; i < techData.length; i++) {
        // Check if A column has red background
        if (techBackgrounds[i][0] === "#ff0000" || techBackgrounds[i][0] === "#FF0000") {
          var trackingNumber = String(techData[i][2]).trim(); // Column C (index 2)

          if (trackingNumber) {
            processedCount++;
            var trackingFound = false;

            // Check if tracking exists in Shipped E column (Shipping TRK #)
            for (var s = 0; s < eDataShipped.length; s++) {
              if (getLastEightDigits(eDataShipped[s][0]) === getLastEightDigits(trackingNumber)) {
                trackingFound = true;
                // Get product name from Shipped C column
                var productName = cDataShipped[s][0];
                techData[i][1] = productName; // Set in B column (index 1)

                // Copy serial numbers from Tech D column to Shipped F column (Serial Number)
                var serialNumbers = String(techData[i][3]).trim(); // D column (index 3)
                if (serialNumbers) {
                  shippedSheet.getRange(s + 2, 6).setValue(serialNumbers); // F column in Shipped (Serial Number)
                }

                // Set tech name in Shipped H column (By)
                var techName = "";
                if (techSheetName === "Tech_1") {
                  techName = "Mike";
                } else if (techSheetName === "Tech_2") {
                  techName = "Thuc";
                } else if (techSheetName === "Tech_3") {
                  techName = "Sang";
                } else if (techSheetName === "Tech_4") {
                  techName = "Tech_4";
                } else if (techSheetName === "Tech_5") {
                  techName = "Tech_5";
                } else if (techSheetName === "Tech_6") {
                  techName = "Tech_6";
                } else if (techSheetName === "Tech_7") {
                  techName = "Tech_7";
                } else if (techSheetName === "Tech_8") {
                  techName = "Tech_8";
                } else if (techSheetName === "Tech_9") {
                  techName = "Tech_9";
                } else if (techSheetName === "Tech_10") {
                  techName = "Tech_10";
                }
                if (techName) {
                  shippedSheet.getRange(s + 2, 8).setValue(techName); // H column in Shipped (By)
                }

                // Clear red background from A column
                techBackgrounds[i][0] = null;

                // Highlight B-E columns green (indices 1-4)
                techBackgrounds[i][1] = "#00FF00"; // B column
                techBackgrounds[i][2] = "#00FF00"; // C column
                techBackgrounds[i][3] = "#00FF00"; // D column
                techBackgrounds[i][4] = "#00FF00"; // E column

                fixedCount++;
                break;
              }
            }

            if (!trackingFound) {
              stillRedCount++;
            }

            rowsToUpdate.push(i + 2); // Store actual row number
          }
        }
      }

      // Update the sheet with new data and backgrounds if any changes were made
      if (rowsToUpdate.length > 0) {
        techRange.setValues(techData);
        techRange.setBackgrounds(techBackgrounds);
      }
    }

    SpreadsheetApp.getUi().alert(
      "Tech Tracking Integrity Check completed.\n" +
      processedCount + " red highlighted rows processed.\n" +
      fixedCount + " tracking numbers found and fixed.\n" +
      stillRedCount + " tracking numbers still not found (remain red)."
    );

  } catch (err) {
    logError("Recheck Tech Tracking Integrity", err);
    SpreadsheetApp.getUi().alert("Error running Tech integrity check: " + err.toString());
  }
}

// Function to recheck Packer sheet tracking numbers in red highlighted B column cells
function recheckPackerTrackingIntegrity() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var shippedSheet = spreadsheet.getSheetByName("Shipped");

    if (!shippedSheet) {
      SpreadsheetApp.getUi().alert("Shipped sheet not found.");
      return;
    }

    var shippedLastRow = shippedSheet.getLastRow();
    var eDataShipped = [];
    var cDataShipped = [];
    if (shippedLastRow >= 2) {
      eDataShipped = shippedSheet.getRange("E2:E" + shippedLastRow).getValues(); // E column (Shipping TRK #)
      cDataShipped = shippedSheet.getRange("C2:C" + shippedLastRow).getValues(); // C column (Product Title)
    }

    var processedCount = 0;
    var fixedCount = 0;
    var stillRedCount = 0;

    // Pre-load Sku-Stock data for SKU lookups
    var skuStockSheet = spreadsheet.getSheetByName('Sku-Stock');
    var skuStockData = [];
    if (skuStockSheet) {
      skuStockData = skuStockSheet.getDataRange().getValues();
    }

    // Process all Packer_X sheets (Packer_1 to Packer_10)
    for (var p = 1; p <= 10; p++) {
      var packerSheetName = "Packer_" + p;
      var packerSheet = spreadsheet.getSheetByName(packerSheetName);

      if (!packerSheet) continue;

      var packerLastRow = packerSheet.getLastRow();
      if (packerLastRow < 2) continue;

      // Get all data and backgrounds for the sheet
      var packerRange = packerSheet.getRange(2, 1, packerLastRow - 1, packerSheet.getLastColumn());
      var packerData = packerRange.getValues();
      var packerBackgrounds = packerRange.getBackgrounds();

      var rowsToUpdate = false;

      for (var i = 0; i < packerData.length; i++) {
        // Check if B column has red background
        if (packerBackgrounds[i][1] === "#ff0000" || packerBackgrounds[i][1] === "#FF0000") {
          var trackingNumber = String(packerData[i][1]).trim(); // Column B (index 1)

          if (trackingNumber) {
            // CASE 1: SKU with Colon
            if (trackingNumber.includes(':')) {
              processedCount++;
              var skuBeforeColon = trackingNumber.split(':')[0].trim();
              var skuFound = false;
              if (skuBeforeColon && skuStockData.length > 1) {
                for (var j = 1; j < skuStockData.length; j++) {
                  if (normalizeSku(skuStockData[j][1]) === normalizeSku(skuBeforeColon)) {
                    var title = String(skuStockData[j][3]).trim();
                    if (title) {
                      packerData[i][3] = title; // D column
                    }
                    packerBackgrounds[i][1] = "#00FF00"; // Green
                    fixedCount++;
                    skuFound = true;
                    rowsToUpdate = true;
                    break;
                  }
                }
              }
              if (!skuFound) stillRedCount++;
            }
            // CASE 2: Tracking Number (Carrier)
            else {
              var carrier = detectCarrier(trackingNumber);
              if (carrier === "UPS" || carrier === "USPS" || carrier === "FedEx") {
                processedCount++;
                var trackingFound = false;

                // Check if tracking exists in Shipped E column (Shipping TRK #)
                for (var s = 0; s < eDataShipped.length; s++) {
                  if (getLastEightDigits(eDataShipped[s][0]) === getLastEightDigits(trackingNumber)) {
                    trackingFound = true;

                    // Copy product title from Shipped C column to Packer D column
                    var productTitle = cDataShipped[s][0]; // C column
                    packerData[i][3] = productTitle; // D column (index 3)

                    // Copy A column timestamp from Packer to Shipped A column
                    var packerTimestamp = packerData[i][0]; // A column from packer
                    if (packerTimestamp) {
                      shippedSheet.getRange(s + 2, 1).setValue(packerTimestamp); // A column in Shipped
                    }

                    // Copy packer name to Shipped G column (Box)
                    var packerName = getPackerName(packerSheetName);
                    shippedSheet.getRange(s + 2, 7).setValue(packerName); // G column (Box) in Shipped

                    // Clear red background from B column and set to green
                    packerBackgrounds[i][1] = "#00FF00"; // B column green

                    fixedCount++;
                    rowsToUpdate = true;
                    break;
                  }
                }

                if (!trackingFound) {
                  stillRedCount++;
                }
              }
            }
          }
        }
      }

      // Update the sheet with new data and backgrounds if any changes were made
      if (rowsToUpdate) {
        packerRange.setValues(packerData);
        packerRange.setBackgrounds(packerBackgrounds);
      }
    }

    // Sort Shipped sheet by A column (A to Z - earliest to latest)
    if (shippedLastRow >= 2) {
      var sortRange = shippedSheet.getRange(2, 1, shippedLastRow - 1, shippedSheet.getLastColumn());
      sortRange.sort(1); // Sort by column 1 (A column)
    }

    SpreadsheetApp.getUi().alert(
      "Packer Tracking Integrity Check completed.\n" +
      processedCount + " red highlighted B column cells processed.\n" +
      fixedCount + " tracking numbers found and fixed.\n" +
      stillRedCount + " tracking numbers still not found (remain red).\n" +
      "Shipped sheet sorted by A column."
    );

  } catch (err) {
    logError("Recheck Packer Tracking Integrity", err);
    SpreadsheetApp.getUi().alert("Error running Packer integrity check: " + err.toString());
  }
}

// ============================================================================
// ZOHO INVENTORY STOCK SYNC FUNCTIONS
// ============================================================================

/**
 * Configuration: Set your Vercel API base URL here
 * Example: "https://your-project.vercel.app"
 */
function getVercelApiUrl() {
  // Get from script properties or hardcode
  var apiUrl = PropertiesService.getScriptProperties().getProperty('VERCEL_API_URL');
  if (!apiUrl) {
    // Default - update this with your Vercel deployment URL
    apiUrl = 'https://your-project.vercel.app';
  }
  return apiUrl.replace(/\/$/, ''); // Remove trailing slash
}

/**
 * Sync stock from Zoho Inventory via Vercel API
 * Reads SKUs from Sku-Stock sheet and updates AvailableQty and Status columns
 */
function syncStockFromZoho() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = spreadsheet.getSheetByName('Sku-Stock');

    if (!sheet) {
      SpreadsheetApp.getUi().alert('Sku-Stock sheet not found.');
      return;
    }

    var lastRow = sheet.getLastRow();
    if (lastRow < 2) {
      SpreadsheetApp.getUi().alert('No data found in Sku-Stock sheet.');
      return;
    }

    // Read SKUs from column B (starting from row 2)
    var skuData = sheet.getRange(2, 2, lastRow - 1, 1).getValues(); // B column
    var skus = [];
    var rowMap = {}; // Map SKU to row number for updates

    for (var i = 0; i < skuData.length; i++) {
      var sku = String(skuData[i][0]).trim();
      if (sku && sku !== '') {
        skus.push(sku);
        rowMap[sku] = i + 2; // Actual row number (header is row 1)
      }
    }

    if (skus.length === 0) {
      SpreadsheetApp.getUi().alert('No SKUs found to sync.');
      return;
    }

    // Ensure AvailableQty and Status columns exist
    // Assuming: A=Qty, B=SKU, C=Serial, D=Title, E=AvailableQty, F=Status
    var headerRow = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var availableQtyCol = -1;
    var statusCol = -1;

    // Find or create AvailableQty column (E = column 5)
    if (headerRow.length < 5 || !headerRow[4] || String(headerRow[4]).trim() === '') {
      sheet.getRange(1, 5).setValue('AvailableQty');
      availableQtyCol = 5;
    } else {
      // Check if column E has "AvailableQty" or find it
      for (var col = 1; col <= headerRow.length; col++) {
        var header = String(headerRow[col - 1] || '').trim().toLowerCase();
        if (header === 'availableqty' || header === 'available qty') {
          availableQtyCol = col;
          break;
        }
      }
      if (availableQtyCol === -1) {
        // Add after last column
        availableQtyCol = headerRow.length + 1;
        sheet.getRange(1, availableQtyCol).setValue('AvailableQty');
      }
    }

    // Find or create Status column (F = column 6, or next after AvailableQty)
    if (headerRow.length < availableQtyCol + 1 || !headerRow[availableQtyCol] || String(headerRow[availableQtyCol]).trim() === '') {
      statusCol = availableQtyCol + 1;
      sheet.getRange(1, statusCol).setValue('Status');
    } else {
      // Check if next column has "Status" or find it
      for (var col = availableQtyCol + 1; col <= headerRow.length; col++) {
        var header = String(headerRow[col - 1] || '').trim().toLowerCase();
        if (header === 'status') {
          statusCol = col;
          break;
        }
      }
      if (statusCol === -1) {
        statusCol = availableQtyCol + 1;
        sheet.getRange(1, statusCol).setValue('Status');
      }
    }

    // Call Vercel API
    var apiUrl = getVercelApiUrl();
    var url = apiUrl + '/api/stock-lookup';

    SpreadsheetApp.getActiveSpreadsheet().toast('Syncing ' + skus.length + ' SKUs from Zoho...', 'Stock Sync', 3);

    var payload = {
      skus: skus
    };

    var options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    var response = UrlFetchApp.fetch(url, options);
    var responseCode = response.getResponseCode();
    var responseText = response.getContentText();

    if (responseCode !== 200) {
      var errorMsg = 'API Error: ' + responseCode;
      try {
        var errorData = JSON.parse(responseText);
        errorMsg += ' - ' + (errorData.error || errorData.message || responseText);
      } catch (e) {
        errorMsg += ' - ' + responseText;
      }
      logError('Stock Sync', errorMsg);
      SpreadsheetApp.getUi().alert('Stock sync failed:\n' + errorMsg);
      return;
    }

    var data = JSON.parse(responseText);
    if (!data.success || !data.results) {
      logError('Stock Sync', 'Invalid API response: ' + responseText);
      SpreadsheetApp.getUi().alert('Stock sync failed: Invalid response from API.');
      return;
    }

    // Update sheet with results
    var results = data.results;
    var updatedCount = 0;
    var errorCount = 0;
    var inStockCount = 0;
    var outOfStockCount = 0;
    var notFoundCount = 0;

    // Prepare batch updates
    var availableQtyValues = [];
    var statusValues = [];

    for (var i = 0; i < skuData.length; i++) {
      var sku = String(skuData[i][0]).trim();
      var result = null;

      // Find matching result
      for (var j = 0; j < results.length; j++) {
        if (String(results[j].sku).trim() === sku) {
          result = results[j];
          break;
        }
      }

      if (result) {
        var availableQty = result.availableQty || 0;
        var status = result.status || 'Not Found';

        availableQtyValues.push([availableQty]);
        statusValues.push([status]);

        updatedCount++;
        if (status === 'In Stock') inStockCount++;
        else if (status === 'Out of Stock') outOfStockCount++;
        else if (status === 'Not Found') notFoundCount++;
        else if (status === 'Error') errorCount++;
      } else {
        // No result found for this SKU
        availableQtyValues.push([0]);
        statusValues.push(['Not Found']);
        notFoundCount++;
      }
    }

    // Batch update columns
    if (availableQtyValues.length > 0) {
      sheet.getRange(2, availableQtyCol, availableQtyValues.length, 1).setValues(availableQtyValues);
      sheet.getRange(2, statusCol, statusValues.length, 1).setValues(statusValues);
    }

    // Apply conditional formatting if not already set
    setupStockConditionalFormatting(sheet, statusCol);

    // Show completion message
    var message = 'Stock sync completed!\n\n' +
      'Updated: ' + updatedCount + ' SKUs\n' +
      'In Stock: ' + inStockCount + '\n' +
      'Out of Stock: ' + outOfStockCount + '\n' +
      'Not Found: ' + notFoundCount;

    if (errorCount > 0) {
      message += '\nErrors: ' + errorCount;
    }

    logInfo('Stock Sync', 'Synced ' + updatedCount + ' SKUs. In Stock: ' + inStockCount);
    SpreadsheetApp.getActiveSpreadsheet().toast(message, 'Stock Sync Complete', 5);
    SpreadsheetApp.getUi().alert(message);

  } catch (err) {
    logError('Stock Sync', err);
    SpreadsheetApp.getUi().alert('Stock sync error: ' + err.toString());
  }
}

/**
 * Setup conditional formatting for stock status
 * Entire row turns green when Status = "In Stock" or AvailableQty > 0
 */
function setupStockConditionalFormatting(sheet, statusCol) {
  try {
    if (!sheet) {
      sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Sku-Stock');
      if (!sheet) return;

      // Find status column
      var headerRow = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      statusCol = -1;
      for (var col = 1; col <= headerRow.length; col++) {
        var header = String(headerRow[col - 1] || '').trim().toLowerCase();
        if (header === 'status') {
          statusCol = col;
          break;
        }
      }
      if (statusCol === -1) return;
    }

    var lastRow = sheet.getLastRow();
    if (lastRow < 2) return;

    // Clear existing conditional formatting rules for data range
    var dataRange = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn());

    // Remove existing rules (we'll add new ones)
    var rules = sheet.getConditionalFormatRules();
    var newRules = [];

    // Keep rules that don't apply to our data range
    for (var i = 0; i < rules.length; i++) {
      var ruleRanges = rules[i].getRanges();
      var appliesToDataRange = false;
      for (var j = 0; j < ruleRanges.length; j++) {
        if (ruleRanges[j].getA1Notation() === dataRange.getA1Notation() ||
          ruleRanges[j].getRow() >= 2) {
          appliesToDataRange = true;
          break;
        }
      }
      if (!appliesToDataRange) {
        newRules.push(rules[i]);
      }
    }

    // Create new rule: Green background when Status = "In Stock"
    var statusRange = sheet.getRange(2, statusCol, lastRow - 1, 1);
    var statusRule = SpreadsheetApp.newConditionalFormatRule()
      .setRanges([dataRange])
      .whenFormulaSatisfied('=$' + String.fromCharCode(64 + statusCol) + '2="In Stock"')
      .setBackground('#00FF00') // Green
      .build();

    newRules.push(statusRule);

    // Create rule: Green background when AvailableQty > 0 (if AvailableQty column exists)
    var availableQtyCol = statusCol - 1;
    if (availableQtyCol > 0) {
      var qtyRule = SpreadsheetApp.newConditionalFormatRule()
        .setRanges([dataRange])
        .whenFormulaSatisfied('=$' + String.fromCharCode(64 + availableQtyCol) + '2>0')
        .setBackground('#00FF00') // Green
        .build();
      newRules.push(qtyRule);
    }

    sheet.setConditionalFormatRules(newRules);
    logInfo('Conditional Formatting', 'Applied stock status formatting to Sku-Stock sheet');

  } catch (err) {
    logError('Conditional Formatting Setup', err);
  }
}

/**
 * Time-driven trigger function for automatic stock sync
 * Runs hourly to keep stock data up to date
 */
function hourlyStockSync() {
  try {
    syncStockFromZoho();
  } catch (err) {
    logError('Hourly Stock Sync', err);
  }
}

/**
 * Setup time-driven trigger for stock sync
 * Call this once to enable automatic hourly syncs
 */
function setupStockSyncTrigger() {
  try {
    // Delete existing triggers for this function
    var triggers = ScriptApp.getProjectTriggers();
    for (var i = 0; i < triggers.length; i++) {
      if (triggers[i].getHandlerFunction() === 'hourlyStockSync') {
        ScriptApp.deleteTrigger(triggers[i]);
      }
    }

    // Create new hourly trigger
    ScriptApp.newTrigger('hourlyStockSync')
      .timeBased()
      .everyHours(1)
      .create();

    SpreadsheetApp.getUi().alert('Hourly stock sync trigger created successfully!');
    logInfo('Stock Sync Trigger', 'Hourly trigger setup completed');

  } catch (err) {
    logError('Setup Stock Sync Trigger', err);
    SpreadsheetApp.getUi().alert('Error setting up trigger: ' + err.toString());
  }
}

/**
 * Remove stock sync trigger
 */
function removeStockSyncTrigger() {
  try {
    var triggers = ScriptApp.getProjectTriggers();
    var removed = 0;
    for (var i = 0; i < triggers.length; i++) {
      if (triggers[i].getHandlerFunction() === 'hourlyStockSync') {
        ScriptApp.deleteTrigger(triggers[i]);
        removed++;
      }
    }
    SpreadsheetApp.getUi().alert('Removed ' + removed + ' stock sync trigger(s).');
    logInfo('Stock Sync Trigger', 'Removed ' + removed + ' trigger(s)');
  } catch (err) {
    logError('Remove Stock Sync Trigger', err);
  }
}

/**
 * Sync all sheet data to Neon DB backend
 * This function gathers data from all sheets and sends it to the backend API
 */
function syncAllSheetsToBackend() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var backendUrl = PropertiesService.getScriptProperties().getProperty('BACKEND_SYNC_URL');
    
    if (!backendUrl) {
      logError('Backend Sync', 'BACKEND_SYNC_URL not set in Script Properties. Please set it in Script Editor > Project Settings > Script Properties');
      SpreadsheetApp.getUi().alert('Backend URL not configured. Please set BACKEND_SYNC_URL in Script Properties.');
      return [];
    }
    
    logInfo('Backend Sync', 'Starting sync to backend...');
    
    // Get all sheet names that need to be synced (starting from 1, not 0)
    var sheetsToSync = [
      'orders',
      'tech_1',
      'tech_2',
      'tech_3',
      'Packer_1',
      'Packer_2',
      'Packer_3',
      'receiving',
      'shipped',
      'sku-stock',
      'Sku-Stock',  // Alternative name
      'sku',
      'Sku'  // Alternative name
    ];
    
    var syncResults = [];
    
    for (var i = 0; i < sheetsToSync.length; i++) {
      var sheetName = sheetsToSync[i];
      var sheet = spreadsheet.getSheetByName(sheetName);
      
      if (!sheet) {
        logInfo('Backend Sync', 'Sheet ' + sheetName + ' not found, skipping...');
        continue;
      }
      
      try {
        // Get all data from sheet
        var lastRow = sheet.getLastRow();
        var lastCol = sheet.getLastColumn();
        
        if (lastRow <= 1) {
          logInfo('Backend Sync', 'Sheet ' + sheetName + ' is empty, skipping...');
          continue;
        }
        
        // Get headers
        var headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
        
        // Get data rows
        var dataRange = sheet.getRange(2, 1, lastRow - 1, lastCol);
        var dataValues = dataRange.getValues();
        
        // Convert to JSON format
        var jsonData = [];
        for (var row = 0; row < dataValues.length; row++) {
          var rowData = {};
          for (var col = 0; col < headers.length; col++) {
            var header = String(headers[col]).trim();
            if (header) {
              var value = dataValues[row][col];
              // Convert dates to strings
              if (value instanceof Date) {
                value = formatDate(value);
              }
              rowData[header] = value;
            }
          }
          // Only add row if it has at least one non-empty value
          var hasData = false;
          for (var key in rowData) {
            if (rowData[key] !== '' && rowData[key] !== null) {
              hasData = true;
              break;
            }
          }
          if (hasData) {
            jsonData.push(rowData);
          }
        }
        
        // Send to backend via Apps Script Web App (which will forward to Python script)
        // For now, we'll use the sync endpoint directly
        var payload = {
          sheet_name: sheetName,
          data: jsonData,
          timestamp: formatDate(new Date())
        };
        
        // Note: The actual sync will be handled by the Python script via APPS_SCRIPT_WEBAPP_URL
        // This function prepares the data and can trigger the sync
        syncResults.push({
          sheet: sheetName,
          rows: jsonData.length,
          status: 'prepared'
        });
        
        logInfo('Backend Sync', 'Prepared ' + jsonData.length + ' rows from ' + sheetName);
        
      } catch (err) {
        logError('Backend Sync - ' + sheetName, err);
        syncResults.push({
          sheet: sheetName,
          status: 'error',
          error: err.toString()
        });
      }
    }
    
    // Trigger backend sync via HTTP request
    try {
      var options = {
        'method': 'post',
        'contentType': 'application/json',
        'payload': JSON.stringify({ action: 'sync_all' }),
        'muteHttpExceptions': true
      };
      
      var response = UrlFetchApp.fetch(backendUrl, options);
      var responseCode = response.getResponseCode();
      var responseText = response.getContentText();
      
      if (responseCode === 200) {
        logInfo('Backend Sync', 'Successfully triggered backend sync');
        SpreadsheetApp.getUi().alert('Backend sync triggered successfully!\n\nPrepared data from ' + syncResults.length + ' sheets.');
      } else {
        logError('Backend Sync', 'Backend returned code ' + responseCode + ': ' + responseText);
        SpreadsheetApp.getUi().alert('Backend sync failed. Check logs for details.');
      }
    } catch (err) {
      logError('Backend Sync - HTTP Request', err);
      SpreadsheetApp.getUi().alert('Error connecting to backend: ' + err.toString());
    }
    
    return syncResults;
    
  } catch (err) {
    logError('Backend Sync', err);
    SpreadsheetApp.getUi().alert('Error during backend sync: ' + err.toString());
    throw err;
  }
}

/**
 * Setup automatic hourly sync to backend
 */
function setupBackendSyncTrigger() {
  try {
    // Remove existing triggers
    var triggers = ScriptApp.getProjectTriggers();
    for (var i = 0; i < triggers.length; i++) {
      if (triggers[i].getHandlerFunction() === 'syncAllSheetsToBackend') {
        ScriptApp.deleteTrigger(triggers[i]);
      }
    }
    
    // Create new hourly trigger
    ScriptApp.newTrigger('syncAllSheetsToBackend')
      .timeBased()
      .everyHours(1)
      .create();
    
    SpreadsheetApp.getUi().alert('Hourly backend sync trigger created successfully!');
    logInfo('Backend Sync Trigger', 'Hourly trigger setup completed');
    
  } catch (err) {
    logError('Setup Backend Sync Trigger', err);
    SpreadsheetApp.getUi().alert('Error setting up trigger: ' + err.toString());
  }
}

/**
 * Remove backend sync trigger
 */
function removeBackendSyncTrigger() {
  try {
    var triggers = ScriptApp.getProjectTriggers();
    var removed = 0;
    for (var i = 0; i < triggers.length; i++) {
      if (triggers[i].getHandlerFunction() === 'syncAllSheetsToBackend') {
        ScriptApp.deleteTrigger(triggers[i]);
        removed++;
      }
    }
    SpreadsheetApp.getUi().alert('Removed ' + removed + ' backend sync trigger(s).');
    logInfo('Backend Sync Trigger', 'Removed ' + removed + ' trigger(s)');
  } catch (err) {
    logError('Remove Backend Sync Trigger', err);
  }
}

/**
 * Sync to Backend - Manual trigger from Integrity menu
 * This function provides a simple interface to sync all sheets to the backend database
 */
function syncToBackend() {
  try {
    // Get backend URL from script properties or use default
    var backendUrl = PropertiesService.getScriptProperties().getProperty('BACKEND_SYNC_URL');
    
    if (!backendUrl) {
      // Try to get from environment or use a default pattern
      // User should set this in Script Properties: Script Editor > Project Settings > Script Properties
      var ui = SpreadsheetApp.getUi();
      var response = ui.prompt(
        'Backend URL Required',
        'Enter your backend sync URL (e.g., https://your-app.vercel.app/api/sync-sheets):',
        ui.ButtonSet.OK_CANCEL
      );
      
      if (response.getSelectedButton() === ui.Button.OK) {
        backendUrl = response.getResponseText().trim();
        if (backendUrl) {
          PropertiesService.getScriptProperties().setProperty('BACKEND_SYNC_URL', backendUrl);
        } else {
          ui.alert('Backend URL cannot be empty. Sync cancelled.');
          return;
        }
      } else {
        ui.alert('Sync cancelled.');
        return;
      }
    }
    
    // Show progress
    var ui = SpreadsheetApp.getUi();
    ui.alert('Starting backend sync...\n\nThis may take a moment.', ui.ButtonSet.OK);
    
    logInfo('Backend Sync (Manual)', 'Starting manual sync to backend');
    
    // Call the existing sync function
    var results = syncAllSheetsToBackend();
    
    // Prepare summary message
    var summary = 'Backend Sync Complete!\n\n';
    var successCount = 0;
    var errorCount = 0;
    var totalRows = 0;
    
    for (var i = 0; i < results.length; i++) {
      var result = results[i];
      if (result.status === 'prepared') {
        successCount++;
        totalRows += result.rows || 0;
      } else if (result.status === 'error') {
        errorCount++;
      }
    }
    
    summary += 'Sheets processed: ' + results.length + '\n';
    summary += 'Successful: ' + successCount + '\n';
    summary += 'Total rows: ' + totalRows + '\n';
    if (errorCount > 0) {
      summary += 'Errors: ' + errorCount + '\n';
    }
    
    summary += '\nCheck logs for detailed information.';
    
    ui.alert(summary);
    logInfo('Backend Sync (Manual)', 'Sync completed: ' + successCount + ' sheets, ' + totalRows + ' rows');
    
  } catch (err) {
    logError('Backend Sync (Manual)', err);
    SpreadsheetApp.getUi().alert('Error during backend sync: ' + err.toString());
  }
}